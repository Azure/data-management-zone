{
    "$schema": "<relative path to createFormUI.schema.json>",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "Enterprise-Scale Analytics - Data Management Zone",
            "steps": [
                {
                    "name": "basics",
                    "label": "Data Management Zone",
                    "elements": [
                        {
                            "name": "infoBoxEnterpriseScaleAnalytics",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": true,
                            "options": {
                                "text": "Enterprise-Scale Analytics is a prescriptive reference architecture for data with reference implementation provided by Microsoft. Visit 'aka.ms/adopt/datamanagement' for more details about the solution pattern.",
                                "style": "Info",
                                "uri": "https://aka.ms/adopt/datamanagement"
                            }
                        },
                        {
							"name": "deploymentDetails",
							"label": "Deployment Details",
							"type": "Microsoft.Common.Section",
                            "visible": true,
							"elements": [
                                {
									"name": "deploymentDetailsText",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "Select the subscription as well as the location to specify the scope of your Data Management Zone deployment.",
										"link": {
											"label": "",
											"uri": ""
										}
									}
								},
                                {
                                    "name": "subscriptionApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "subscriptions?api-version=2020-01-01"
                                    }
                                },
                                {
                                    "name": "subscriptionId",
                                    "label": "Subscription",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Select the Subscription of your Data Landing Zone.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(steps('basics').deploymentDetails.subscriptionApi.value, (item) => parse(concat('{\"label\":\"', item.displayName, '\",\"value\":\"', item.id, '\",\"description\":\"', 'ID: ', item.subscriptionId, '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "infoBoxLocation",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": true,
                                    "options": {
                                        "text": "Since not all service features are available in all regions, Enterprise-Scale Analytics is available in a subset of regions.",
                                        "style": "Info"
                                    }
                                },
                                {
                                    "name": "locationsApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "locations?api-version=2019-11-01"
                                    }
                                },
                                {
                                    "name": "locationName",
                                    "label": "Location",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Select the Location for your Deployment.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(filter(steps('basics').deploymentDetails.locationsApi.value,(item) => contains(split('southafricanorth,southeastasia,japaneast,canadacentral,northeurope,westeurope,francecentral,germanywestcentral,uksouth,centralus,eastus,eastus2,southcentralus,westus2', ','), item.name)),(item) => parse(concat('{\"label\":\"', item.regionalDisplayName, '\",\"value\":\"', item.name, '\"}')))]",
                                        "required": true
                                    }
                                }
                            ]
                        },
                        {
							"name": "dataManagementZoneName",
							"label": "Data Management Zone Name",
							"type": "Microsoft.Common.Section",
                            "visible": true,
							"elements": [
                                {
									"name": "dataManagementZoneNameText",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "Specify a prefix and environment name which will be used as a prefix for all resource names.",
										"link": {
											"label": "",
											"uri": ""
										}
									}
								},
                                {
                                    "name": "dataManagementZonePrefix",
                                    "label": "Data Management Zone Prefix",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Specify a prefix (min 1 and max 10 lowercase characters and numbers).",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9]{1,10}$",
                                        "validationMessage": "The prefix must be between 1-10 lowercase characters and numbers."
                                    }
                                },
                                {
                                    "name": "environment",
                                    "label": "Environment",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "Development",
                                    "toolTip": "Select the environment for the deployment.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Development",
                                                "description": "Select if you want to deploy a development environment.",
                                                "value": "dev"
                                            },
                                            {
                                                "label": "Test",
                                                "description": "Select if you want to deploy a test environment.",
                                                "value": "tst"
                                            },
                                            {
                                                "label": "Production",
                                                "description": "Select if you want to deploy a production environment.",
                                                "value": "prd"
                                            }
                                        ],
                                        "required": true
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "generalSettings",
                    "label": "General Settings",
                    "subLabel": {
                        "preValidation": "Provide all general settings for your Data Management Zone.",
                        "postValidation": "Done"
                    },
                    "bladeTitle": "General Settings",
                    "bladeSubtitle": "General Settings",
                    "elements": []
                },
                {
                    "name": "connectivitySettings",
                    "label": "Connectivity Settings",
                    "subLabel": {
                        "preValidation": "Provide all connectivity settings for your Data Management Zone.",
                        "postValidation": "Done"
                    },
                    "bladeTitle": "Connectivity Settings",
                    "bladeSubtitle": "Connectivity Settings",
                    "elements": [
                        {
							"name": "virtualNetworkConfiguration",
							"label": "Virtual Network Configuration",
							"type": "Microsoft.Common.Section",
                            "visible": true,
							"elements": [
                                {
                                    "name": "virtualNetworkAddressCidrRange",
                                    "label": "Vnet Address CIDR Range",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": true,
                                    "defaultValue": "10.0.0.0/16",
                                    "toolTip": "Specify a Vnet address CIDR range within the range [10,24].",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:$|/(1[0-9]|2[0-4]))$",
                                        "validationMessage": "Invalid CIDR range. The address prefix must be in the range [10,24]."
                                    }
                                },
                                {
                                    "name": "azureFirewallSubnetCidrRange",
                                    "label": "Azure Firewall Subnet CIDR Range",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": true,
                                    "defaultValue": "10.0.0.0/24",
                                    "toolTip": "Specify a CIDR range for the Azure Firewall Subnet within the range [24,28].",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:$|/(2[4-8]))$",
                                        "validationMessage": "Invalid CIDR range. The address prefix must be in the range [24,28]."
                                    }
                                },
                                {
                                    "name": "servicesSubnetCidrRange",
                                    "label": "Services Subnet CIDR Range",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": true,
                                    "defaultValue": "10.0.1.0/24",
                                    "toolTip": "Specify a CIDR range for the Subnet to which privat endpoints and other services will be connected. The subnet should be within the range [24,28].",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:$|/(2[4-8]))$",
                                        "validationMessage": "Invalid CIDR range. The address prefix must be in the range [24,28]."
                                    }
                                }
                            ]
                        },
                        {
							"name": "firewallConfiguration",
							"label": "Firewall Configuration",
							"type": "Microsoft.Common.Section",
                            "visible": true,
							"elements": [
                                {
                                    "name": "enableDnsAndFirewallDeployment",
                                    "label": "Enable DNS and Azure Firewall Deployment",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "visible": true,
                                    "toolTip": "If 'Yes' is selected, an Azure Firewall and all required Private DNS Zones will be deployed in the Data Management Zone.",
                                    "defaultValue": "Yes",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Yes",
                                                "value": "yes"
                                            },
                                            {
                                                "label": "No",
                                                "value": "no"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "firewallPrivateIp",
                                    "label": "Firewall Private IP Address",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[equals(steps('connectivitySettings').firewallConfiguration.enableDnsAndFirewallDeployment, 'no')]",
                                    "defaultValue": "10.0.0.4",
                                    "toolTip": "Specify the private IP address of your Firewall.",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)$",
                                        "validationMessage": "Invalid CIDR range. The address prefix must be in the range [10,24]."
                                    }
                                },
                                {
                                    "name": "dnsServerAdresses",
                                    "label": "DNS Server Addresses",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[equals(steps('connectivitySettings').firewallConfiguration.enableDnsAndFirewallDeployment, 'no')]",
                                    "defaultValue": "10.0.0.4",
                                    "toolTip": "Specify the private IP addresses of your DNS forwarders. You can specify more than one private IP address ('10.0.0.4,10.0.0.5').",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(,)?)*$",
                                        "validationMessage": "Invalid CIDR range. The address prefix must be in the range [10,24]."
                                    }
                                },
                                {
                                    "name": "enableFirewallRulesDeployment",
                                    "label": "Deploy Rules to Azure Firewall Policy",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "visible": "[equals(steps('connectivitySettings').firewallConfiguration.enableDnsAndFirewallDeployment, 'no')]",
                                    "toolTip": "If 'Yes' is selected, you will have to select an Azure Firewall Policy to which network and application rules will be deployed.",
                                    "defaultValue": "No",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Yes",
                                                "value": "yes"
                                            },
                                            {
                                                "label": "No",
                                                "value": "no"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "infoBoxFirewallRulesDeployment",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": "[equals(steps('connectivitySettings').firewallConfiguration.enableFirewallRulesDeployment, 'yes')]",
                                    "options": {
                                        "text": "Please follow the link for more details about the application and network firewall policy rules that are being applied.",
                                        "style": "Info",
                                        "uri": "https://github.com/Azure/data-management-zone/blob/main/infra/modules/services/firewallPolicyRules.bicep"
                                    }
                                },
                                {
                                    "name": "firewallPolicyApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat(steps('basics').deploymentDetails.subscriptionId, '/providers/Microsoft.Network/firewallPolicies?api-version=2020-11-01')]"
                                    }
                                },
                                {
                                    "name": "firewallPolicyId",
                                    "label": "Firewall Policy",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": "[equals(steps('connectivitySettings').firewallConfiguration.enableFirewallRulesDeployment, 'yes')]",
                                    "defaultValue": "",
                                    "toolTip": "Select the Firewall Policy where the rules will be deployed.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(steps('connectivitySettings').firewallConfiguration.firewallPolicyApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\",\"description\":\"', 'Subscription ID: ', last(take(split(item.id, '/'), 3)), '\"}')))]",
                                        "required": true
                                    }
                                }
                            ]
                        },
                        {
							"name": "privateDnsZones",
							"label": "Private DNS Zones",
							"type": "Microsoft.Common.Section",
                            "visible": "[equals(steps('connectivitySettings').firewallConfiguration.enableDnsAndFirewallDeployment, 'no')]",
							"elements": [
                                {
									"name": "privateDnsZonesText",
									"type": "Microsoft.Common.TextBlock",
									"visible": true,
									"options": {
										"text": "Select the Private DNS Zones for your deployment.",
										"link": {
											"label": "",
											"uri": ""
										}
									}
								},
                                {
                                    "name": "infoBoxPrivateDnsZone",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": true,
                                    "options": {
                                        "text": "We are deploying all services with private endpoints and disabled public network access to reduce the data exfiltration risk. For each private endpoint, DNS A-records need to be created in a Private DNS Zones. Therefore, you have to provide the Private DNS Zones that should be used for this deployment. We are assuming that all Private DNS Zones are created in the same subscription.",
                                        "style": "Info"
                                    }
                                },
                                {
									"name": "privateDnsZonesSub",
									"label": "Private DNS Zone Subscription",
									"type":"Microsoft.Common.SubscriptionSelector",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Subscription of Private DNS Zones."
								},
                                {
                                    "name": "privateDnsZonesApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat('/subscriptions/', steps('connectivitySettings').privateDnsZones.privateDnsZonesSub.subscriptionId, '/providers/Microsoft.Network/privateDnsZones?api-version=2018-09-01')]"
                                    }
                                },
                                {
                                    "name": "privateDnsZoneIdKeyVault",
                                    "label": "Private DNS Zone Key Vault (privatelink.vaultcore.azure.net)",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Private DNS Zone for Key Vault (privatelink.vaultcore.azure.net).",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(filter(steps('connectivitySettings').privateDnsZones.privateDnsZonesApi.value,(item) => contains(item.name, 'privatelink.vaultcore.azure.net')),(item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\",\"description\":\"', 'Resource Group: ', last(take(split(item.id, '/'), 5)), '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "privateDnsZoneIdBlob",
                                    "label": "Private DNS Zone Blob Storage (privatelink.blob.core.windows.net)",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Private DNS Zone for Blob Storage (privatelink.blob.core.windows.net).",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(filter(steps('connectivitySettings').privateDnsZones.privateDnsZonesApi.value,(item) => contains(item.name, 'privatelink.blob.core.windows.net')),(item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\",\"description\":\"', 'Resource Group: ', last(take(split(item.id, '/'), 5)), '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "privateDnsZoneIdQueue",
                                    "label": "Private DNS Zone Queue Storage (privatelink.queue.core.windows.net)",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Private DNS Zone for Queue Storage (privatelink.queue.core.windows.net).",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(filter(steps('connectivitySettings').privateDnsZones.privateDnsZonesApi.value,(item) => contains(item.name, 'privatelink.queue.core.windows.net')),(item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\",\"description\":\"', 'Resource Group: ', last(take(split(item.id, '/'), 5)), '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "privateDnsZoneIdContainerRegistry",
                                    "label": "Private DNS Zone Container Registry (privatelink.azurecr.io)",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Private DNS Zone for Synapse Sql (privatelink.azurecr.io).",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(filter(steps('connectivitySettings').privateDnsZones.privateDnsZonesApi.value,(item) => contains(item.name, 'privatelink.azurecr.io')),(item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\",\"description\":\"', 'Resource Group: ', last(take(split(item.id, '/'), 5)), '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "privateDnsZoneIdNamespace",
                                    "label": "Private DNS Zone EventHub Namespace (privatelink.servicebus.windows.net)",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Private DNS Zone for EventHub Namespace (privatelink.servicebus.windows.net).",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(filter(steps('connectivitySettings').privateDnsZones.privateDnsZonesApi.value,(item) => contains(item.name, 'privatelink.servicebus.windows.net')),(item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\",\"description\":\"', 'Resource Group: ', last(take(split(item.id, '/'), 5)), '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "privateDnsZoneIdPurview",
                                    "label": "Private DNS Zone Purview (privatelink.purview.azure.com)",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Private DNS Zone for Purview (privatelink.purview.azure.com).",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(filter(steps('connectivitySettings').privateDnsZones.privateDnsZonesApi.value,(item) => contains(item.name, 'privatelink.purview.azure.com')),(item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\",\"description\":\"', 'Resource Group: ', last(take(split(item.id, '/'), 5)), '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "privateDnsZoneIdSynapse",
                                    "label": "Private DNS Zone Synapse Private Link Hub (privatelink.azuresynapse.net)",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Private DNS Zone for Synapse Private Link Hub (privatelink.azuresynapse.net).",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(filter(steps('connectivitySettings').privateDnsZones.privateDnsZonesApi.value,(item) => contains(item.name, 'privatelink.azuresynapse.net')),(item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\",\"description\":\"', 'Resource Group: ', last(take(split(item.id, '/'), 5)), '\"}')))]",
                                        "required": true
                                    }
                                }
							]
						}
                    ]
                },
                {
                    "name": "tags",
                    "label": "Tags",
                    "subLabel": {
                        "preValidation": "Provide tags that will be used for all resources.",
                        "postValidation": "Done"
                    },
                    "bladeTitle": "Tags",
                    "bladeSubtitle": "Tags",
                    "elements": [
                        {
                            "name": "tagsByResource",
                            "label": "Tags by Resource",
                            "type": "Microsoft.Common.TagsByResource",
                            "visible": true,
                            "resources": [
                                "EnterpriseScaleAnalytics"
                            ]
                        }
                    ]
                }
            ]
        },
        "deployment": {
            "kind": "Subscription",
            "location": "[steps('basics').deploymentDetails.locationName]",
            "parameters": {
                "environment": "[steps('basics').dataManagementZoneName.environment]",
                "tags": "[steps('tags').tagsByResource.EnterpriseScaleAnalytics]"
            }
        }
    }
}