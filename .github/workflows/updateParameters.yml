name: Update Parameter Files

on:
  push:
    branches: [main]
    paths:
      - 'configs/**'
      - '.github/workflows/updateParameters.yml'

env:
  DATA_HUB_SUBSCRIPTION_ID: '17588eb2-2943-461a-ab3f-00a3ceac3112'
  DATA_HUB_NAME: 'dh-jp'
  LOCATION: 'eastus'
  AZURE_RESOURCE_MANAGER_CONNECTION_NAME: 'esa-1'
  NODE_VNET_ID: '<my-node-vnet-id2>'

jobs:
  renaming:
    runs-on: ubuntu-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Check Out Repository
        id: checkout_repository
        uses: actions/checkout@v2
      
      # Install Required Packages
      - name: Install Required Modules
        id: install_modules
        run: |
          echo "Install Modules"
          pwsh -Command "Set-PSRepository -Name "PSGallery" -InstallationPolicy Trusted"
          pwsh -Command "Install-Module -Name powershell-yaml"
      
      # Update Parameters
      - name: Update Parameters
        id: update_parameters
        run: |
          echo "Updating Parameters"
          pwsh $GITHUB_WORKSPACE/configs/UpdateParameters.ps1 \
            -ConfigurationFilePath 'configs/config.json' \
            -DataLandingZoneSubscriptionId '${{ env.DATA_HUB_SUBSCRIPTION_ID }}' \
            -DataLandingZoneName '${{ env.DATA_HUB_NAME }}' \
            -Location '${{ env.LOCATION }}' \
            -NodeVnetId '${{ env.NODE_VNET_ID }}' \
            -AzureResourceManagerConnectionName '${{ env.AZURE_RESOURCE_MANAGER_CONNECTION_NAME }}'
      
      # Create Pull Request
      - name: Create Pull Request
        id: create_pull_request
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: 'Updated Parameters'
          branch: 'parameter_update_${{ github.run_id }}'
          title: 'Updated Parameters with GitHub Workflow Run ID ${{ github.run_id }}'
          body: 'One last step to complete. Please Update the GitHub Workflow or ADO workflow environment variables in <a href="/.github/workflows/dataHubDeployment.yml">`/.github/workflows/dataHubDeployment.yml`</a> to the following \n * AZURE_SUBSCRIPTION_ID to `${{ steps.update_parameters.outputs.DataLandingZoneSubscriptionId }}`, \n* AZURE_RESOURCE_GROUP_NAME, AZURE_LOCATION, etc.) as described [here]().'
