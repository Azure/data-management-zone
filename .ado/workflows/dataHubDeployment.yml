name: Data Hub Deployment
trigger:
  branches:
    include:
    - main
  paths:
    include:
    - infra/ArtifactStorage/*
    - infra/ContainerRegistry/*
    - infra/DnsForwarder/*
    - infra/Firewall/*
    - infra/FirewallPolicy/*
    - infra/KeyVault/*
    - infra/PrivateDns/*
    - infra/Purview/*
    - infra/SynapsePrivateLinkHub/*
    - infra/VirtualNetwork/*
    - infra/VirtualNetworkPeering/*
    - .ado/workflows/dataHubDeployment.yml
    - code/GeneratePassword.ps1
variables:
  AZURE_RESOURCE_MANAGER_CONNECTION_NAME: <my-resource-manager-connection-name>
  AZURE_SUBSCRIPTION_ID: <my-data-hub-subscription-id>
  AZURE_RESOURCE_GROUP_NAME_NETWORK: <my-data-hub-name>-network
  AZURE_RESOURCE_GROUP_NAME_GLOBAL_DNS: <my-data-hub-name>-global-dns
  AZURE_RESOURCE_GROUP_NAME_AUTOMATION: <my-data-hub-name>-automation
  AZURE_RESOURCE_GROUP_NAME_MANAGEMENT: <my-data-hub-name>-mgmt
  AZURE_RESOURCE_GROUP_NAME_CONSUMPTION: <my-data-hub-name>-consumption
  AZURE_RESOURCE_GROUP_NAME_CONTAINER: <my-data-hub-name>-container
  AZURE_RESOURCE_GROUP_NAME_GOVERNANCE: <my-data-hub-name>-governance
  AZURE_LOCATION: <my-region>
stages:
- stage: Validation
  displayName: Validation of ARM templates
  jobs:
  - job: Validation
    displayName: Validation of ARM templates
    continueOnError: false
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
      name: checkout_repository
      displayName: Checkout repository
      submodules: true
      lfs: false
      clean: true
      continueOnError: false
      enabled: true
    - task: AzureResourceManagerTemplateDeployment@3
      name: vnet_validation
      displayName: Deploy Vnet - validation
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_NETWORK)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/VirtualNetwork/deploy.vnet.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/VirtualNetwork/params.vnet001.json
        deploymentMode: Validation
    - task: AzureResourceManagerTemplateDeployment@3
      name: artifact_storage_001_validation
      displayName: Deploy Artifact Storage Account 001 - validation
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_NETWORK)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/ArtifactStorage/deploy.storage.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/ArtifactStorage/params.storage001.json
        deploymentMode: Validation
    - task: AzureResourceManagerTemplateDeployment@3
      name: firewall_policy_validation
      displayName: Deploy Firewall Policy 001 - validation
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_NETWORK)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/FirewallPolicy/deploy.firewallPolicy.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/FirewallPolicy/params.firewallPolicy001.json
        deploymentMode: Validation
    - task: AzureResourceManagerTemplateDeployment@3
      name: firewall_validation
      displayName: Deploy Firewall 001 - validation
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_NETWORK)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/Firewall/deploy.firewall.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/Firewall/params.firewall001.json
        deploymentMode: Validation
    - task: AzureResourceManagerTemplateDeployment@3
      name: dns_forwarder_validation
      displayName: Deploy DNS Forwarder - validation
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_GLOBAL_DNS)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/DnsForwarder/deploy.dnsForwarder.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/DnsForwarder/params.dnsForwarder001.json
        deploymentMode: Validation
    - task: AzureResourceManagerTemplateDeployment@3
      name: private_dns_zones_validation
      displayName: Deploy Private DNS Zones - validation
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_GLOBAL_DNS)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/PrivateDns/deploy.privateDns.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/PrivateDns/params.privateDns001.json
        deploymentMode: Validation
    - task: AzureResourceManagerTemplateDeployment@3
      name: vnet_peering_001_validation
      displayName: Deploy Vnet Peering 001 - validation
      enabled: true
      continueOnError: true
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_NETWORK)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/VirtualNetworkPeering/deploy.vnetPeering.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/VirtualNetworkPeering/params.vnetPeering001.json
        deploymentMode: Validation
    - task: AzureResourceManagerTemplateDeployment@3
      name: key_vault_001_validation
      displayName: Deploy Key Vault 001 - validation
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_GOVERNANCE)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/KeyVault/deploy.keyVault.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/KeyVault/params.keyVault001.json
        deploymentMode: Validation
    - task: AzureResourceManagerTemplateDeployment@3
      name: purview_001_validation
      displayName: Deploy Purview 001 - validation
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_GOVERNANCE)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/Purview/deploy.purview.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/Purview/params.purview001.json
        deploymentMode: Validation
    - task: AzureResourceManagerTemplateDeployment@3
      name: container_registry_001_validation
      displayName: Deploy Container Registry 001 - validation
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_CONTAINER)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/ContainerRegistry/deploy.containerRegistry.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/ContainerRegistry/params.containerRegistry001.json
        deploymentMode: Validation
    - task: AzureResourceManagerTemplateDeployment@3
      name: synapse_private_link_hub_001_validation
      displayName: Deploy Synapse Private Link Hub 001 - validation
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_CONSUMPTION)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/SynapsePrivateLinkHub/deploy.synapsePrivateLinkHub.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/SynapsePrivateLinkHub/params.synapsePrivateLinkHub001.json
        deploymentMode: Validation
- stage: Deployment
  displayName: Deployment of ARM templates
  dependsOn: Validation
  condition: and(succeeded(), in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI'))
  jobs:
  - job: Deployment
    displayName: Deployment of ARM templates
    continueOnError: false
    pool:
      vmImage: vs2017-win2016
    steps:
    - checkout: self
      name: checkout_repository
      displayName: Checkout repository
      submodules: true
      lfs: false
      clean: true
      continueOnError: false
      enabled: true
    - task: AzureResourceManagerTemplateDeployment@3
      name: vnet_deployment
      displayName: Deploy Vnet
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_NETWORK)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/VirtualNetwork/deploy.vnet.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/VirtualNetwork/params.vnet001.json
        deploymentMode: Incremental
    - task: AzureResourceManagerTemplateDeployment@3
      name: firewall_policy_deployment
      displayName: Deploy Firewall Policy 001
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_NETWORK)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/FirewallPolicy/deploy.firewallPolicy.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/FirewallPolicy/params.firewallPolicy001.json
        deploymentMode: Incremental
    - task: AzureResourceManagerTemplateDeployment@3
      name: firewall_deployment
      displayName: Deploy Firewall 001
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_NETWORK)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/Firewall/deploy.firewall.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/Firewall/params.firewall001.json
        deploymentMode: Incremental
    - task: AzureResourceManagerTemplateDeployment@3
      name: private_dns_zones_deployment
      displayName: Deploy Private DNS Zones
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_GLOBAL_DNS)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/PrivateDns/deploy.privateDns.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/PrivateDns/params.privateDns001.json
        deploymentMode: Incremental
    - task: AzureResourceManagerTemplateDeployment@3
      name: vnet_peering_001_deployment
      displayName: Deploy Vnet Peering 001
      enabled: true
      continueOnError: true
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_NETWORK)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/VirtualNetworkPeering/deploy.vnetPeering.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/VirtualNetworkPeering/params.vnetPeering001.json
        deploymentMode: Incremental
    - task: AzureResourceManagerTemplateDeployment@3
      name: key_vault_001_deployment
      displayName: Deploy Key Vault 001
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_GOVERNANCE)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/KeyVault/deploy.keyVault.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/KeyVault/params.keyVault001.json
        deploymentMode: Incremental
    - task: AzureResourceManagerTemplateDeployment@3
      name: purview_001_deployment
      displayName: Deploy Purview 001
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_GOVERNANCE)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/Purview/deploy.purview.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/Purview/params.purview001.json
        deploymentMode: Incremental
    - task: AzureResourceManagerTemplateDeployment@3
      name: container_registry_001_deployment
      displayName: Deploy Container Registry 001
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_CONTAINER)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/ContainerRegistry/deploy.containerRegistry.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/ContainerRegistry/params.containerRegistry001.json
        deploymentMode: Incremental
    - task: AzureResourceManagerTemplateDeployment@3
      name: synapse_private_link_hub_001_deployment
      displayName: Deploy Synapse Private Link Hub 001
      enabled: true
      continueOnError: false
      inputs:
        deploymentScope: Resource Group
        azureResourceManagerConnection: $(AZURE_RESOURCE_MANAGER_CONNECTION_NAME)
        subscriptionId: $(AZURE_SUBSCRIPTION_ID)
        action: Create Or Update Resource Group
        resourceGroupName: $(AZURE_RESOURCE_GROUP_NAME_CONSUMPTION)
        location: $(AZURE_LOCATION)
        templateLocation: Linked artifact
        csmFile: $(System.DefaultWorkingDirectory)/infra/SynapsePrivateLinkHub/deploy.synapsePrivateLinkHub.json
        csmParametersFile: $(System.DefaultWorkingDirectory)/infra/SynapsePrivateLinkHub/params.synapsePrivateLinkHub001.json
        deploymentMode: Incremental

