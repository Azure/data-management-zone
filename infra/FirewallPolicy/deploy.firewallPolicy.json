{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Specifies the location for all resources."
            }
        },
        "firewallPolicyName": {
            "type": "string",
            "metadata": {
                "description": "Specifies the name of the firewall policy."
            }
        }
    },
    "functions": [],
    "variables": {
        "location": "[parameters('location')]",
        "firewallPolicyName": "[parameters('firewallPolicyName')]"
    },
    "resources": [
        {
            "type": "Microsoft.Network/firewallPolicies",
            "apiVersion": "2020-05-01",
            "name": "[variables('firewallPolicyName')]",
            "location": "[variables('location')]",
            "properties": {
                "basePolicy": {
                    "id": ""
                },
                "dnsSettings": {
                    "enableProxy": true,
                    "servers": []
                },
                // "intrusionSystemMode": "Enabled",
                "threatIntelMode": "Deny",
                "threatIntelWhitelist": {
                    "fqdns": [],
                    "ipAddresses": []
                }
            }
        },
        {
            "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
            "apiVersion": "2020-05-01",
            "name": "[concat(variables('firewallPolicyName'), '/', 'networkrules-rulecollection')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/firewallPolicies', variables('firewallPolicyName'))]"
            ],
            "properties": {
                "priority": 10000,
                "ruleCollections": [
                    {
                        "name": "MachineLearning-NetworkRules",
                        "priority": 10100,
                        "action": {
                            "type": "Allow"
                        },
                        "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                        "rules": [
                            {
                                "name": "MachineLearning-NetworkRule-001",
                                "ruleType": "NetworkRule",
                                "ipProtocols": [
                                    "TCP"
                                ],
                                "sourceAddresses": [
                                    "*"
                                ],
                                "sourceIpGroups": [],
                                "destinationAddresses": [
                                    "AzureActiveDirectory",
                                    "AzureMachineLearning",
                                    "AzureResourceManager",
                                    "Storage",
                                    "AzureKeyVault",
                                    "AzureContainerRegistry",
                                    "MicrosoftContainerRegistry",
                                    "AzureFrontDoor.FirstParty"
                                ],
                                "destinationIpGroups": [],
                                "destinationFqdns": [],
                                "destinationPorts": [
                                    "*"
                                ],
                                "description": "Allow outbound access to required services"
                            }
                        ]
                    },
                    {
                        "name": "HDInsight-NetworkRules",
                        "priority": 10200,
                        "action": {
                            "type": "Allow"
                        },
                        "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                        "rules": [
                            {
                                "name": "HDInsight-NetworkRule-001",
                                "ruleType": "NetworkRule",
                                "ipProtocols": [
                                    "TCP"
                                ],
                                "sourceAddresses": [
                                    "*"
                                ],
                                "sourceIpGroups": [],
                                "destinationAddresses": [
                                    "Sql"
                                ],
                                "destinationIpGroups": [],
                                "destinationFqdns": [],
                                "destinationPorts": [
                                    "1433"
                                ],
                                "description": "Allow default SQL servers provided by HDInsight"
                            },
                            {
                                "name": "HDInsight-NetworkRule-002",
                                "ruleType": "NetworkRule",
                                "ipProtocols": [
                                    "TCP"
                                ],
                                "sourceAddresses": [
                                    "*"
                                ],
                                "sourceIpGroups": [],
                                "destinationAddresses": [
                                    "AzureMonitor"
                                ],
                                "destinationIpGroups": [],
                                "destinationFqdns": [],
                                "destinationPorts": [
                                    "*"
                                ],
                                "description": "Allows scale feature of HDInsight"
                            }
                        ]
                    },
                    {
                        "name": "Databricks-NetworkRules",
                        "priority": 10300,
                        "action": {
                            "type": "Allow"
                        },
                        "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                        "rules": [
                            {
                                "name": "Databricks-NetworkRule-001",
                                "ruleType": "NetworkRule",
                                "ipProtocols": [
                                    "TCP"
                                ],
                                "sourceAddresses": [
                                    "*"
                                ],
                                "sourceIpGroups": [],
                                "destinationAddresses": [
                                    "AzureActiveDirectory",
                                    "AzureFrontDoor.Frontend"
                                ],
                                "destinationIpGroups": [],
                                "destinationFqdns": [],
                                "destinationPorts": [
                                    "443"
                                ],
                                "description": "Allow OAuth flow for the User to the Workspace Private Endpoint and features like Mount Points, Credential Passthrough, etc."
                            }
                        ]
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
            "apiVersion": "2020-05-01",
            "name": "[concat(variables('firewallPolicyName'), '/', 'applicationrules-rulecollection')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/firewallPolicies', variables('firewallPolicyName'))]",
                "[resourceId('Microsoft.Network/firewallPolicies/ruleCollectionGroups', variables('firewallPolicyName'), 'networkrules-rulecollection')]"
            ],
            "properties": {
                "priority": 20000,
                "ruleCollections": [
                    {
                        "name": "MachineLearning-ApplicationRules",
                        "priority": 20100,
                        "action": {
                            "type": "Allow"
                        },
                        "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                        "rules": [
                            {
                                "name": "MachineLearning-ApplicationRule-001",
                                "ruleType": "ApplicationRule",
                                "protocols": [
                                    {
                                        "protocolType": "Http",
                                        "port": 80
                                    },
                                    {
                                        "protocolType": "Https",
                                        "port": 443
                                    }
                                ],
                                "fqdnTags": [],
                                "targetFqdns": [
                                    "anaconda.com",
                                    "*.anaconda.com",
                                    "*.anaconda.org",
                                    "pypi.org",
                                    "cloud.r-project.org",
                                    "*pytorch.org",
                                    "*.tensorflow.org",
                                    "*.instances.azureml.net",
                                    "*.instances.azureml.ms"
                                ],
                                "targetUrls": [],
                                "terminateTLS": false,
                                "sourceAddresses": [
                                    "*"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": [],
                                "description": "MachineLearning allow common FQDNs"
                            }
                        ]
                    },
                    {
                        "name": "HDInsight-ApplicationRules",
                        "priority": 20200,
                        "action": {
                            "type": "Allow"
                        },
                        "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                        "rules": [
                            {
                                "name": "HDInsight-ApplicationRule-001",
                                "ruleType": "ApplicationRule",
                                "protocols": [
                                    {
                                        "protocolType": "Http",
                                        "port": 80
                                    },
                                    {
                                        "protocolType": "Https",
                                        "port": 443
                                    }
                                ],
                                "fqdnTags": [
                                    "HDInsight",
                                    "WindowsUpdate"
                                ],
                                "targetFqdns": [],
                                "targetUrls": [],
                                "terminateTLS": false,
                                "sourceAddresses": [
                                    "*"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": [],
                                "description": "HDInsight Service Tag Rule"
                            },
                            {
                                "name": "HDInsight-ApplicationRule-002",
                                "ruleType": "ApplicationRule",
                                "protocols": [
                                    {
                                        "protocolType": "Https",
                                        "port": 443
                                    }
                                ],
                                "fqdnTags": [],
                                "targetFqdns": [
                                    "login.microsoftonline.com",
                                    "login.windows.net"
                                ],
                                "targetUrls": [],
                                "terminateTLS": false,
                                "sourceAddresses": [
                                    "*"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": [],
                                "description": "Allows Windows login activity"
                            }
                        ]
                    },
                    {
                        "name": "DataFactory-ApplicationRules",
                        "priority": 20300,
                        "action": {
                            "type": "Allow"
                        },
                        "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                        "rules": [
                            {
                                "name": "DataFactory-ApplicationRule-001",
                                "ruleType": "ApplicationRule",
                                "protocols": [
                                    {
                                        "protocolType": "Http",
                                        "port": 80
                                    },
                                    {
                                        "protocolType": "Https",
                                        "port": 443
                                    }
                                ],
                                "fqdnTags": [
                                ],
                                "targetFqdns": [
                                    "go.microsoft.com",
                                    "download.microsoft.com",
                                    "browser.events.data.msn.com"
                                ],
                                "targetUrls": [],
                                "terminateTLS": false,
                                "sourceAddresses": [
                                    "*"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": [],
                                "description": "Allows download of Self-hosted Integration Runtime installer and updates"
                            },
                            {
                                "name": "DataFactory-ApplicationRule-002",
                                "ruleType": "ApplicationRule",
                                "protocols": [
                                    {
                                        "protocolType": "Https",
                                        "port": 443
                                    }
                                ],
                                "fqdnTags": [],
                                "targetFqdns": [
                                    "*.servicebus.windows.net"
                                ],
                                "targetUrls": [],
                                "terminateTLS": false,
                                "sourceAddresses": [
                                    "*"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": [],
                                "description": "Allows interactive authoring with Self-hosted Integration Runtime"
                            }
                        ]
                    }
                ]
            }
        }
    ],
    "outputs": {
        "firewallPolicyId": {
            "type": "string",
            "value": "[resourceId('Microsoft.Network/firewallPolicies', variables('firewallPolicyName'))]"
        }
    }
}